{% extends 'base.html' %}

{% block title %}Gestion des Consommations - Soir√©e Clash{% endblock %}

{% block content %}
<div class="hero-section">
  <div class="crystal-container">
    <div class="crystal-shards"></div>
    <div class="electric-arcs"></div>
    <div class="crystal-core"></div>
    <div class="energy-pulses"></div>
  </div>
  
  <h1 class="page-title crystal-title">
    <span class="crystal-char" data-char="üç∫">üç∫</span>
    <span class="crystal-char" data-char="G">G</span>
    <span class="crystal-char" data-char="e">e</span>
    <span class="crystal-char" data-char="s">s</span>
    <span class="crystal-char" data-char="t">t</span>
    <span class="crystal-char" data-char="i">i</span>
    <span class="crystal-char" data-char="o">o</span>
    <span class="crystal-char" data-char="n">n</span>
    <span class="crystal-char" data-char=" "> </span>
    <span class="crystal-char" data-char="d">d</span>
    <span class="crystal-char" data-char="e">e</span>
    <span class="crystal-char" data-char="s">s</span>
    <span class="crystal-char" data-char=" "> </span>
    <span class="crystal-char" data-char="C">C</span>
    <span class="crystal-char" data-char="o">o</span>
    <span class="crystal-char" data-char="n">n</span>
    <span class="crystal-char" data-char="s">s</span>
    <span class="crystal-char" data-char="o">o</span>
    <span class="crystal-char" data-char="m">m</span>
    <span class="crystal-char" data-char="m">m</span>
    <span class="crystal-char" data-char="a">a</span>
    <span class="crystal-char" data-char="t">t</span>
    <span class="crystal-char" data-char="i">i</span>
    <span class="crystal-char" data-char="o">o</span>
    <span class="crystal-char" data-char="n">n</span>
    <span class="crystal-char" data-char="s">s</span>
  </h1>
  <p class="page-subtitle crystal-subtitle">Enregistrez les consommations des participants de votre √©tablissement</p>
</div>

<!-- Informations de l'√©tablissement -->
<div class="section">
  <div class="etablissement-card">
    <div class="etablissement-header">
      <div class="etablissement-icon">üè™</div>
      <div class="etablissement-info">
        <h3>{{ service.nom }}</h3>
        <p class="etablissement-type">{{ service.get_type_display }}</p>
        <p class="etablissement-location">{{ service.localisation }}</p>
      </div>
    </div>
    <div class="etablissement-stats">
      <div class="stat-item">
        <span class="stat-label">Participants actifs</span>
        <span class="stat-value">{{ service.participant_set.count }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Types de boissons</span>
        <span class="stat-value">{{ service.typeboisson_set.count }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Formulaire d'enregistrement de consommation -->
<div class="section">
  <h2 class="section-title">Enregistrer une Consommation</h2>
  <div class="form-container">
    <form method="post" class="consommation-form">
      {% csrf_token %}
      <div class="form-grid">
        <div class="form-group">
          <label for="{{ form.participant.id_for_label }}">Participant</label>
          {{ form.participant }}
          <small class="form-help">S√©lectionnez le participant qui a consomm√©</small>
        </div>
        
        <div class="form-group">
          <label for="{{ form.type_boisson.id_for_label }}">Type de boisson</label>
          {{ form.type_boisson }}
          <small class="form-help">Type de boisson consomm√©e</small>
        </div>
        
        <div class="form-group">
          <label for="{{ form.quantite.id_for_label }}">Quantit√©</label>
          {{ form.quantite }}
          <small class="form-help">Nombre d'unit√©s consomm√©es</small>
        </div>
        
        <div class="form-group">
          <label for="{{ form.prix_unitaire.id_for_label }}">Prix unitaire (FCFA)</label>
          {{ form.prix_unitaire }}
          <small class="form-help">Prix par unit√© (sera calcul√© automatiquement si laiss√© vide)</small>
        </div>
      </div>
      
      <div class="consommation-preview">
        <div class="preview-item">
          <span class="preview-label">Montant total estim√© :</span>
          <span class="preview-value" id="montant-total">--</span>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Enregistrer la Consommation</button>
      </div>
    </form>
  </div>
</div>

<!-- Consommations r√©centes -->
<div class="section">
  <h2 class="section-title">Consommations R√©centes</h2>
  
  {% if consommations %}
    <div class="consommations-grid">
      {% for consommation in consommations %}
        <div class="consommation-card">
          <div class="consommation-header">
            <div class="consommation-participant">{{ consommation.participant.pseudo }}</div>
            <div class="consommation-date">{{ consommation.date_consommation|date:"d/m/Y √† H:i" }}</div>
          </div>
          
          <div class="consommation-details">
            <div class="detail-item">
              <span class="detail-label">Boisson :</span>
              <span class="detail-value">{{ consommation.type_boisson.get_categorie_display }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Quantit√© :</span>
              <span class="detail-value">{{ consommation.quantite }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Prix unitaire :</span>
              <span class="detail-value">{{ consommation.prix_unitaire|floatformat:0 }} FCFA</span>
            </div>
            <div class="detail-item total">
              <span class="detail-label">Total :</span>
              <span class="detail-value">{{ consommation.montant_total|floatformat:0 }} FCFA</span>
            </div>
          </div>
          
          <div class="consommation-footer">
            <span class="saisi-par">Saisi par {{ consommation.saisi_par.pseudo }}</span>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <!-- Statistiques des consommations -->
    <div class="stats-section">
      <h3 class="stats-title">Statistiques du Jour</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üç∫</div>
          <div class="stat-content">
            <div class="stat-number">{{ consommations|length }}</div>
            <div class="stat-label">Consommations</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-content">
            <div class="stat-number">
              {% with total=0 %}
                {% for c in consommations %}
                  {% with total=total|add:c.montant_total %}{% endwith %}
                {% endfor %}
                {{ total|floatformat:0 }}
              {% endwith %} FCFA
            </div>
            <div class="stat-label">Montant total</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-content">
            <div class="stat-number">
              {% with participants=consommations|length %}
                {% for c in consommations %}
                  {% if forloop.first %}
                    {% with participants=1 %}
                      {% for c2 in consommations %}
                        {% if c2.participant != c.participant %}
                          {% with participants=participants|add:1 %}{% endwith %}
                        {% endif %}
                      {% endfor %}
                      {{ participants }}
                    {% endwith %}
                  {% endif %}
                {% endfor %}
              {% endwith %}
            </div>
            <div class="stat-label">Participants</div>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">üç∫</div>
      <h3>Aucune consommation enregistr√©e</h3>
      <p>Commencez par enregistrer les premi√®res consommations des participants.</p>
    </div>
  {% endif %}
</div>

<!-- Instructions importantes -->
<div class="section info-section">
  <h2 class="section-title">Instructions Importantes</h2>
  <div class="info-grid">
    <div class="info-card">
      <div class="info-icon">‚è∞</div>
      <h3>D√©lai de saisie</h3>
      <p>Les r√©sultats doivent √™tre saisis au plus tard √† 12h00 pour le calcul des classements du jour.</p>
    </div>
    <div class="info-card">
      <div class="info-icon">üìä</div>
      <h3>Classements</h3>
      <p>Les classements se basent sur le montant total d√©pens√© par chaque participant.</p>
    </div>
    <div class="info-card">
      <div class="info-icon">üí∞</div>
      <h3>Calcul automatique</h3>
      <p>Le montant total est calcul√© automatiquement (quantit√© √ó prix unitaire).</p>
    </div>
    <div class="info-card">
      <div class="info-icon">‚úÖ</div>
      <h3>V√©rification</h3>
      <p>V√©rifiez bien les informations avant de valider chaque consommation.</p>
    </div>
  </div>
</div>

<style>
.hero-section {
  text-align: center;
  padding: 3rem 0;
  background: linear-gradient(135deg, rgba(255,0,77,0.1) 0%, rgba(255,215,0,0.1) 100%);
  border-radius: 1rem;
  margin-bottom: 2rem;
  position: relative; /* Added for crystal animation positioning */
  overflow: hidden; /* Added for crystal animation overflow */
}

.crystal-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none; /* Allow clicks to pass through */
  z-index: -1; /* Ensure it's behind other content */
}

.crystal-shards, .electric-arcs, .crystal-core, .energy-pulses {
  position: absolute;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
  border-radius: 50%;
  opacity: 0.5;
  animation: pulse 8s infinite;
}

.crystal-shards {
  width: 100px;
  height: 100px;
  top: -50px;
  left: 20%;
  animation-delay: -2s;
}

.electric-arcs {
  width: 200px;
  height: 200px;
  top: 30%;
  left: 50%;
  animation-delay: -4s;
}

.crystal-core {
  width: 150px;
  height: 150px;
  top: 60%;
  left: 80%;
  animation-delay: -6s;
}

.energy-pulses {
  width: 300px;
  height: 300px;
  top: 10%;
  left: 10%;
  animation-delay: -8s;
}

.page-title {
  font-size: 3rem;
  font-weight: 800;
  background: linear-gradient(to right, #FF004D, #FFD700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 1rem;
}

.crystal-title {
  font-size: 3rem;
  font-weight: 800;
  background: linear-gradient(to right, #FF004D, #FFD700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 1rem;
  position: relative; /* Added for crystal animation positioning */
  overflow: hidden; /* Added for crystal animation overflow */
}

.crystal-char {
  display: inline-block;
  transition: transform 0.5s ease;
}

.crystal-title:hover .crystal-char {
  transform: translateY(-10px);
}

.page-subtitle {
  font-size: 1.2rem;
  color: #FFD700;
}

.crystal-subtitle {
  font-size: 1.2rem;
  color: #FFD700;
}

.section {
  margin-bottom: 3rem;
}

.section-title {
  color: #FFD700;
  font-size: 2rem;
  text-align: center;
  margin-bottom: 2rem;
  border-bottom: 2px solid #7B2CBF;
  padding-bottom: 1rem;
}

.etablissement-card {
  background: rgba(26, 18, 58, 0.9);
  border-radius: 1rem;
  padding: 2rem;
  border: 2px solid #7B2CBF;
  margin-bottom: 2rem;
}

.etablissement-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
}

.etablissement-icon {
  font-size: 3rem;
  margin-right: 1.5rem;
}

.etablissement-info h3 {
  color: #FFD700;
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.etablissement-type {
  color: #00C2FF;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.etablissement-location {
  color: #7B2CBF;
  font-size: 0.9rem;
}

.etablissement-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.stat-item {
  text-align: center;
  padding: 1rem;
  background: rgba(123, 44, 191, 0.2);
  border-radius: 0.5rem;
}

.stat-label {
  display: block;
  color: #7B2CBF;
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.stat-value {
  color: #FFD700;
  font-size: 1.5rem;
  font-weight: 600;
}

.form-container {
  max-width: 800px;
  margin: 0 auto;
}

.consommation-form {
  background: rgba(26, 18, 58, 0.8);
  padding: 2rem;
  border-radius: 1rem;
  border: 2px solid #7B2CBF;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  color: #FFD700;
  font-weight: 600;
}

.form-control {
  width: 100%;
  padding: 0.8rem;
  border: 1px solid #7B2CBF;
  border-radius: 0.5rem;
  background: rgba(255,255,255,0.1);
  color: #fff;
  font-size: 1rem;
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: #FFD700;
  box-shadow: 0 0 10px rgba(255,215,0,0.3);
}

.form-help {
  display: block;
  margin-top: 0.5rem;
  color: #7B2CBF;
  font-size: 0.9rem;
}

.consommation-preview {
  background: rgba(123, 44, 191, 0.2);
  padding: 1.5rem;
  border-radius: 0.5rem;
  margin-bottom: 2rem;
  text-align: center;
}

.preview-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.preview-label {
  color: #7B2CBF;
  font-size: 1rem;
}

.preview-value {
  color: #FFD700;
  font-size: 1.5rem;
  font-weight: 600;
}

.form-actions {
  text-align: center;
}

.consommations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 2rem;
  margin-bottom: 2rem;
}

.consommation-card {
  background: rgba(26, 18, 58, 0.9);
  border-radius: 1rem;
  padding: 1.5rem;
  border: 2px solid #7B2CBF;
  transition: all 0.3s ease;
}

.consommation-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(123, 44, 191, 0.3);
}

.consommation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(123, 44, 191, 0.3);
}

.consommation-participant {
  font-size: 1.2rem;
  font-weight: 600;
  color: #FFD700;
}

.consommation-date {
  color: #7B2CBF;
  font-size: 0.9rem;
}

.consommation-details {
  margin-bottom: 1rem;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.detail-item.total {
  border-top: 1px solid rgba(123, 44, 191, 0.3);
  padding-top: 0.5rem;
  margin-top: 0.5rem;
}

.detail-label {
  color: #7B2CBF;
  font-size: 0.9rem;
}

.detail-value {
  font-weight: 600;
  color: #fff;
}

.detail-value.total {
  color: #00FF00;
  font-size: 1.1rem;
}

.consommation-footer {
  text-align: center;
  padding-top: 1rem;
  border-top: 1px solid rgba(123, 44, 191, 0.3);
}

.saisi-par {
  color: #7B2CBF;
  font-size: 0.8rem;
}

.stats-section {
  background: rgba(26, 18, 58, 0.5);
  padding: 2rem;
  border-radius: 1rem;
  border: 2px solid #7B2CBF;
}

.stats-title {
  color: #FFD700;
  text-align: center;
  margin-bottom: 2rem;
  font-size: 1.5rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 2rem;
}

.stat-card {
  display: flex;
  align-items: center;
  padding: 1.5rem;
  background: rgba(26, 18, 58, 0.8);
  border-radius: 1rem;
  border: 2px solid #7B2CBF;
}

.stat-icon {
  font-size: 2.5rem;
  margin-right: 1rem;
}

.stat-content {
  flex: 1;
}

.stat-number {
  color: #FFD700;
  font-size: 1.8rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.stat-label {
  color: #7B2CBF;
  font-size: 0.9rem;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: #7B2CBF;
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.info-section {
  background: rgba(26, 18, 58, 0.3);
  padding: 2rem;
  border-radius: 1rem;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2rem;
}

.info-card {
  text-align: center;
  padding: 1.5rem;
}

.info-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.info-card h3 {
  color: #FFD700;
  margin-bottom: 1rem;
}

@media (max-width: 768px) {
  .page-title {
    font-size: 2rem;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .consommations-grid {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .etablissement-header {
    flex-direction: column;
    text-align: center;
  }
  
  .etablissement-icon {
    margin-right: 0;
    margin-bottom: 1rem;
  }
  
  .preview-item {
    flex-direction: column;
    gap: 0.5rem;
  }
}

@keyframes pulse {
  0% {
    transform: scale(0.8);
    opacity: 0.7;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.9;
  }
  100% {
    transform: scale(0.8);
    opacity: 0.7;
  }
}
</style>

<script>
// Calculateur de montant total en temps r√©el
document.addEventListener('DOMContentLoaded', function() {
  const quantiteInput = document.getElementById('{{ form.quantite.id_for_label }}');
  const prixInput = document.getElementById('{{ form.prix_unitaire.id_for_label }}');
  const montantTotal = document.getElementById('montant-total');
  
  function calculerMontant() {
    const quantite = parseFloat(quantiteInput.value) || 0;
    const prix = parseFloat(prixInput.value) || 0;
    const total = quantite * prix;
    
    if (total > 0) {
      montantTotal.textContent = total.toFixed(0) + ' FCFA';
      montantTotal.style.color = '#FFD700';
    } else {
      montantTotal.textContent = '--';
      montantTotal.style.color = '#7B2CBF';
    }
  }
  
  if (quantiteInput && prixInput && montantTotal) {
    quantiteInput.addEventListener('input', calculerMontant);
    prixInput.addEventListener('input', calculerMontant);
  }
});
</script>
{% endblock %}
