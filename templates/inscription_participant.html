{% extends 'base.html' %}
{% load static %}

{% block title %}Inscription Participant - Soir√©e Clash{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient text-white text-center py-4">
                    <div class="crystal-container">
                        <div class="crystal-shards"></div>
                        <div class="electric-arcs"></div>
                        <div class="crystal-core"></div>
                        <div class="energy-pulses"></div>
                    </div>
                    
                    <h2 class="mb-0 crystal-title">
                        <span class="crystal-char" data-char="üéØ">üéØ</span>
                        <span class="crystal-char" data-char="I">I</span>
                        <span class="crystal-char" data-char="n">n</span>
                        <span class="crystal-char" data-char="s">s</span>
                        <span class="crystal-char" data-char="c">c</span>
                        <span class="crystal-char" data-char="r">r</span>
                        <span class="crystal-char" data-char="i">i</span>
                        <span class="crystal-char" data-char="p">p</span>
                        <span class="crystal-char" data-char="t">t</span>
                        <span class="crystal-char" data-char="i">i</span>
                        <span class="crystal-char" data-char="o">o</span>
                        <span class="crystal-char" data-char="n">n</span>
                        <span class="crystal-char" data-char=" "> </span>
                        <span class="crystal-char" data-char="P">P</span>
                        <span class="crystal-char" data-char="a">a</span>
                        <span class="crystal-char" data-char="r">r</span>
                        <span class="crystal-char" data-char="t">t</span>
                        <span class="crystal-char" data-char="i">i</span>
                        <span class="crystal-char" data-char="c">c</span>
                        <span class="crystal-char" data-char="i">i</span>
                        <span class="crystal-char" data-char="p">p</span>
                        <span class="crystal-char" data-char="a">a</span>
                        <span class="crystal-char" data-char="n">n</span>
                        <span class="crystal-char" data-char="t">t</span>
                    </h2>
                    <p class="mb-0 mt-2 crystal-subtitle">Rejoignez la comp√©tition et devenez le champion de votre √©tablissement !</p>
                </div>
                
                <div class="card-body p-5">
                    {% if messages %}
                        <div class="messages-container mb-4">
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    <div class="d-flex align-items-center">
                                        <div class="message-icon me-3">
                                            {% if message.tags == 'success' %}‚úÖ{% elif message.tags == 'error' %}‚ùå{% elif message.tags == 'warning' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}
                                        </div>
                                        <div class="message-content">
                                            {{ message }}
                                        </div>
                                    </div>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.pseudo.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-user-tag me-2"></i>Pseudo *
                                </label>
                                {{ form.pseudo }}
                                {% if form.pseudo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.pseudo.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Choisissez un pseudo unique qui vous repr√©sentera</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-envelope me-2"></i>Email *
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.email.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Votre email pour la connexion et les notifications</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.nom.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-user me-2"></i>Nom
                                </label>
                                {{ form.nom }}
                                {% if form.nom.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.nom.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.prenom.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-user me-2"></i>Pr√©nom
                                </label>
                                {{ form.prenom }}
                                {% if form.prenom.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.prenom.errors %}
                                            <span class="text-danger">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.service.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-building me-2"></i>√âtablissement *
                            </label>
                            {{ form.service }}
                            {% if form.service.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.service.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Choisissez l'√©tablissement o√π vous souhaitez participer</small>
                        </div>
                        
                        <!-- Champ photo du participant -->
                        <div class="mb-4">
                            <label for="{{ form.photo.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-camera me-2"></i>Votre Photo (Optionnel)
                            </label>
                            {{ form.photo }}
                            {% if form.photo.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.photo.errors %}
                                        <span class="text-danger">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                üì∏ Ajoutez votre photo pour personnaliser votre profil. 
                                Format recommand√© : carr√©, max 2MB. 
                                L'image sera automatiquement redimensionn√©e √† 300x300 pixels.
                            </small>
                        </div>
                        
                        <!-- Section des boissons disponibles -->
                        <div id="boissons-disponibles" class="mb-4" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-glass-martini me-2"></i>
                                        Boissons disponibles dans cet √©tablissement
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="liste-boissons">
                                        <!-- Les boissons seront affich√©es ici dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-user-plus me-2"></i>
                                S'inscrire et rejoindre la comp√©tition
                            </button>
                        </div>
                        
                        <div class="text-center mt-4">
                            <p class="text-muted mb-2">D√©j√† inscrit ?</p>
                            <a href="{% url 'app:login' %}" class="btn btn-outline-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                Se connecter
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Informations suppl√©mentaires -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        <i class="fas fa-info-circle me-2"></i>
                        Comment √ßa marche ?
                    </h5>
                    
                    <!-- Syst√®me d'ench√®res (Bo√Ætes de nuit) -->
                    <div class="mb-4">
                        <h6 class="text-info">
                            <i class="fas fa-gavel me-2"></i>
                            üé≠ Bo√Ætes de nuit - Syst√®me d'ench√®res
                        </h6>
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-user-plus fa-2x"></i>
                                </div>
                                <h6 class="mt-2">1. Inscription</h6>
                                <small class="text-muted">Cr√©ez votre compte avec un pseudo unique</small>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-gavel fa-2x"></i>
                                </div>
                                <h6 class="mt-2">2. Ench√®res</h6>
                                <small class="text-muted">Proposez le prix le plus √©lev√© pour les boissons s√©lectionn√©es</small>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-crown fa-2x"></i>
                                </div>
                                <h6 class="mt-2">3. Victoire</h6>
                                <small class="text-muted">Le plus offrant remporte le troph√©e !</small>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>üí° Astuce :</strong> Dans les bo√Ætes de nuit, c'est la <strong>strat√©gie d'ench√®res</strong> qui compte, pas la quantit√© consomm√©e !
                        </div>
                    </div>
                    
                    <!-- Syst√®me de prix fixes (Maquis) -->
                    <div class="mb-4">
                        <h6 class="text-success">
                            <i class="fas fa-tags me-2"></i>
                            üç∫ Maquis - Syst√®me de prix fixes
                        </h6>
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-user-plus fa-2x"></i>
                                </div>
                                <h6 class="mt-2">1. Inscription</h6>
                                <small class="text-muted">Cr√©ez votre compte avec un pseudo unique</small>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-glass-martini fa-2x"></i>
                                </div>
                                <h6 class="mt-2">2. Consommation</h6>
                                <small class="text-muted">Consommez le plus possible avec les prix √©tablis</small>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="fas fa-coins fa-2x"></i>
                                </div>
                                <h6 class="mt-2">3. Victoire</h6>
                                <small class="text-muted">Celui qui d√©pense le plus remporte le troph√©e !</small>
                            </div>
                        </div>
                        <div class="alert alert-success">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>üí° Astuce :</strong> Dans les maquis, c'est la <strong>quantit√© consomm√©e</strong> qui d√©termine le vainqueur !
                        </div>
                    </div>
                    
                    <!-- R√®gles communes -->
                    <div class="border-top pt-3">
                        <h6 class="text-primary">
                            <i class="fas fa-shield-alt me-2"></i>
                            üìã R√®gles communes
                        </h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Un pseudo unique par participant</li>
                            <li><i class="fas fa-check text-success me-2"></i>Participation possible dans un seul √©tablissement</li>
                            <li><i class="fas fa-check text-success me-2"></i>R√©sultats calcul√©s quotidiennement</li>
                            <li><i class="fas fa-check text-success me-2"></i>Troph√©es attribu√©s selon le syst√®me de l'√©tablissement</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.gradient-text {
    background: linear-gradient(45deg, #FF004D, #FFD700, #00C2FF, #7B2CBF);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradient-shift 3s ease-in-out infinite;
}

@keyframes gradient-shift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.card-header {
    background: linear-gradient(135deg, #FF004D 0%, #7B2CBF 100%);
}

.btn-primary {
    background: linear-gradient(135deg, #FF004D 0%, #7B2CBF 100%);
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 0, 77, 0.3);
}

.form-control:focus {
    border-color: #FF004D;
    box-shadow: 0 0 0 0.2rem rgba(255, 0, 77, 0.25);
}

.messages-container .alert {
    border-radius: 15px;
    border: none;
}

.message-icon {
    font-size: 1.2em;
}

            .bg-primary {
                background: linear-gradient(135deg, #7B2CBF 0%, #00C2FF 100%) !important;
            }
            
            #boissons-disponibles .card {
                transition: all 0.3s ease;
            }
            
            #boissons-disponibles .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(123, 44, 191, 0.3);
            }
            
            .boisson-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                margin: 0.25rem 0;
                background: rgba(123, 44, 191, 0.1);
                border-radius: 8px;
                border-left: 4px solid #7B2CBF;
            }
            
            .boisson-categorie {
                font-weight: 600;
                color: #7B2CBF;
            }
            
            .boisson-prix {
                background: linear-gradient(135deg, #FFD700, #FFA500);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-weight: 600;
                font-size: 0.9rem;
            }
            
            /* Styles pour les syst√®mes d'ench√®res */
            .boisson-encheres {
                border-left: 4px solid #00C2FF;
                background: rgba(0, 194, 255, 0.1);
            }
            
            .boisson-encheres .boisson-categorie {
                color: #00C2FF;
            }
            
            .boisson-systeme {
                background: linear-gradient(135deg, #00C2FF, #7B2CBF);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-weight: 600;
                font-size: 0.9rem;
            }
            
            /* Styles pour les prix fixes */
            .boisson-prix-fixe {
                border-left: 4px solid #7B2CBF;
                background: rgba(123, 44, 191, 0.1);
            }
            
            .boisson-prix-fixe .boisson-categorie {
                color: #7B2CBF;
            }
            
            /* Alertes stylis√©es */
            .alert-info {
                background: linear-gradient(135deg, rgba(0, 194, 255, 0.1), rgba(123, 44, 191, 0.1));
                border: 2px solid #00C2FF;
                color: #00C2FF;
            }
            
            .alert-success {
                background: linear-gradient(135deg, rgba(123, 44, 191, 0.1), rgba(255, 0, 77, 0.1));
                border: 2px solid #7B2CBF;
                color: #7B2CBF;
            }
        </style>
        
        <script>
            // Donn√©es des boissons par √©tablissement
            const boissonsParEtablissement = {{ boissons_par_etablissement|safe }};
            
            console.log('üîç Donn√©es des boissons re√ßues:', boissonsParEtablissement);
            
            // Fonction pour afficher les boissons d'un √©tablissement
            function afficherBoissons(etablissementId) {
                console.log('üîç Affichage des boissons pour l\'√©tablissement:', etablissementId);
                
                const sectionBoissons = document.getElementById('boissons-disponibles');
                const listeBoissons = document.getElementById('liste-boissons');
                
                if (!sectionBoissons || !listeBoissons) {
                    console.error('‚ùå √âl√©ments HTML non trouv√©s');
                    return;
                }
                
                if (etablissementId && boissonsParEtablissement[etablissementId]) {
                    const etablissement = boissonsParEtablissement[etablissementId];
                    const boissons = etablissement.boissons;
                    
                    console.log('üîç √âtablissement trouv√©:', etablissement);
                    console.log('üîç Boissons:', boissons);
                    
                    if (boissons && boissons.length > 0) {
                        // Afficher la section
                        sectionBoissons.style.display = 'block';
                        
                        // G√©n√©rer le HTML selon le type d'√©tablissement
                        let html = `
                            <div class="mb-3">
                                <strong>${etablissement.nom}</strong> 
                                <span class="badge bg-secondary ms-2">${etablissement.type}</span>
                            </div>
                        `;
                        
                        if (etablissement.systeme === 'ench√®res') {
                            // Syst√®me d'ench√®res pour les bo√Ætes de nuit
                            html += `
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-gavel me-2"></i>
                                    <strong>Syst√®me d'ench√®res</strong> - Le vainqueur est celui qui propose le prix le plus √©lev√© !
                                </div>
                                <div class="row">
                            `;
                            
                            boissons.forEach(boisson => {
                                html += `
                                    <div class="col-md-6 mb-2">
                                        <div class="boisson-item boisson-encheres">
                                            <span class="boisson-categorie">${boisson.categorie}</span>
                                            <span class="boisson-systeme">üíé Ench√®res</span>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            // Syst√®me de prix fixes pour les maquis
                            html += `
                                <div class="alert alert-success mb-3">
                                    <i class="fas fa-tags me-2"></i>
                                    <strong>Prix fixes</strong> - Les prix sont √©tablis et stables
                                </div>
                                <div class="row">
                            `;
                            
                            boissons.forEach(boisson => {
                                html += `
                                    <div class="col-md-6 mb-2">
                                        <div class="boisson-item boisson-prix-fixe">
                                            <span class="boisson-categorie">${boisson.categorie}</span>
                                            <span class="boisson-prix">${boisson.prix_vente} FCFA</span>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        html += '</div>';
                        listeBoissons.innerHTML = html;
                        
                        // Animation d'apparition
                        sectionBoissons.style.opacity = '0';
                        sectionBoissons.style.transform = 'translateY(20px)';
                        sectionBoissons.style.transition = 'all 0.5s ease';
                        
                        setTimeout(() => {
                            sectionBoissons.style.opacity = '1';
                            sectionBoissons.style.transform = 'translateY(0)';
                        }, 100);
                        
                        console.log('‚úÖ Boissons affich√©es avec succ√®s');
                        
                    } else {
                        // Aucune boisson disponible
                        sectionBoissons.style.display = 'block';
                        listeBoissons.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p>Aucune boisson enregistr√©e pour cet √©tablissement</p>
                            </div>
                        `;
                        console.log('‚ö†Ô∏è Aucune boisson disponible');
                    }
                } else {
                    // Masquer la section si aucun √©tablissement s√©lectionn√©
                    sectionBoissons.style.display = 'none';
                    console.log('‚ùå √âtablissement non trouv√© ou pas de donn√©es');
                }
            }
            
            // √âcouter les changements de s√©lection d'√©tablissement
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üîç DOM charg√©, initialisation...');
                
                const serviceSelect = document.getElementById('service-select');
                console.log('üîç Select service trouv√©:', serviceSelect);
                
                if (serviceSelect) {
                    // Afficher les boissons de l'√©tablissement s√©lectionn√© par d√©faut
                    if (serviceSelect.value) {
                        console.log('üîç √âtablissement s√©lectionn√© par d√©faut:', serviceSelect.value);
                        afficherBoissons(serviceSelect.value);
                    }
                    
                    // √âcouter les changements
                    serviceSelect.addEventListener('change', function() {
                        console.log('üîç Changement d\'√©tablissement:', this.value);
                        afficherBoissons(this.value);
                    });
                } else {
                    console.error('‚ùå Select service non trouv√©');
                }
            });
        </script>
{% endblock %}
